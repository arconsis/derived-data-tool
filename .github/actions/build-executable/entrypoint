#!/usr/bin/env swift
import Foundation

// MARK: - Logging + Exit Functions
func log(_ message: String) {
    print("[build-executable] \(message)")
}
func writeStandardError(_ message: String) {
    if let data = (message + "\n").data(using: .utf8) {
        FileHandle.standardError.write(data)
    }
}
func exitWithError(_ message: String) -> Never {
    writeStandardError("❌ \(message)")
    exit(1)
}

// MARK: - Shell Helpers
@discardableResult
func system(_ command: String) -> Int32 {
    let task = Process()
    task.launchPath = "/bin/bash"
    task.arguments = ["-c", command]
    task.launch()
    task.waitUntilExit()
    return task.terminationStatus
}
func shellOutput(_ command: String) -> String {
    let task = Process()
    task.launchPath = "/bin/bash"
    task.arguments = ["-c", command]
    let pipe = Pipe()
    task.standardOutput = pipe
    task.launch()
    let data = pipe.fileHandleForReading.readDataToEndOfFile()
    task.waitUntilExit()
    return String(data: data, encoding: .utf8) ?? ""
}

// MARK: - Argument Parsing
var arch: String?
var output: String?
var args = CommandLine.arguments.dropFirst()
while let arg = args.first {
    switch arg {
    case "--arch":
        args = args.dropFirst()
        arch = args.first
    case "--output":
        args = args.dropFirst()
        output = args.first
    default:
        exitWithError("Unknown option: \(arg)")
    }
    args = args.dropFirst()
}
if arch == nil || output == nil {
    exitWithError("Missing required arguments.")
}
// MARK: - Build Logic
let archValue = arch!
let outputValue = output!
if archValue == "universal" {
    log("Building universal binary (arm64 & x86_64)...")
    let _ = system("swift build -c release --arch arm64 --arch x86_64")
    let binPath = shellOutput("swift build -c release --show-bin-path")
    let appPath = binPath.trimmingCharacters(in: .whitespacesAndNewlines) + "/App"
    let _ = system("cp \(appPath) \(outputValue)")
} else if archValue == "arm64" || archValue == "x86_64" {
    log("Building for \(archValue)...")
    let _ = system("swift build -c release --arch \(archValue)")
    let binPath = shellOutput("swift build -c release --show-bin-path")
    let appPath = binPath.trimmingCharacters(in: .whitespacesAndNewlines) + "/App"
    let _ = system("cp \(appPath) \(outputValue)")
} else {
    exitWithError("Unknown architecture: \(archValue)")
}
log("Build completed: \(outputValue)")